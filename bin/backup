#!/usr/bin/env bash
if command -v realpath >/dev/null 2>&1; then
    SCRIPTS="$(dirname $(realpath "${BASH_SOURCE[0]}" 2>/dev/null))"
elif command -v readlink >/dev/null 2>&1 \
    && readlink --canonicalize-existing ~ >/dev/null 2>&1; then
    SCRIPTS="$(dirname $(readlink --canonicalize-existing ${BASH_SOURCE[0]}))"
else
    SCRIPTS=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P)
    if [ "$SCRIPTS" == "${HOME}" ]; then echo "Where am I"; exit 1; fi
fi
. $SCRIPTS/../conf/bashrc --short

export ARCHIVE_RECIPIENT="me+backup@taylorlmoney.com"
FOLDERS='documents local pictures'
backup_status() {
    GOOG=`echo $(( $(date +%s) - $(stat -f%c $LOCALDOT/status/google.lastbackup) ))`
    DAY="86400"
    DAYTwo="172800"
    DAYThree="259200"
    if [ "$GOOG" -ge "$DAY" ]; then echo $(( $GOOG / $DAY )); fi
    if [ "$1" != "-q" ]; then
        for f in $LOCALDOT/status/*.lastbackup; do
            echo -n "$f" | sed 's:.*/\(.*\).lastbackup:\1:'
            cat $f
        done
    fi
}


backup_important() {
    for f in $FOLDERS; do
        cd ~/$f
        build ssh with-agent build git autocommit
    done

    cd ~/
    if [ "$ARCHIVE_RECIPIENT" ]; then
        build archive archive -f word .password-store ~/local/archive
        build archive archive -f local .local-dot ~/local/archive
    fi
}

backup_installs() {
    build install store $DOT/install
}

archive-live() {
    cd "$1"
    pwd
    local f
    for f in *; do
        if [ "$f" != "archive" ]; then
            build archive archive -f "$f".working "$f" archive
        fi
    done
}

rsync-to-backup() {
    local f="$1"
    echo "rsyncing $1"
    $TIMEOUT rsync -av --delete-excluded --delete --exclude='.tags' ~/$f/archive $(build drive directory)/$f/
}

backup-google() {
    name="google"
    completed=""
    local f
    cd ~
    for f in $FOLDERS; do
        cd ~
        archive-live "$f"
        rsync-to-backup "$f"
        if [ "$?" != "0" ]; then completed="no"; fi
    done
    $TIMEOUT build drive backup
    if [ "$?" != "0" ]; then completed="no"; fi
    if [ "$completed" == "" ]; then
        date > $LOCALDOT/status/${name}.lastbackup
    fi
}


if [ ! -f $LOCALDOT/status/backup.me ]; then
    exit
fi

export TIMEOUT="build etc timeout 1200"
if [ "$1" == "--full" ]; then
    TIMEOUT=""
    shift
fi

for a in $@; do
    if [ "$a" == "important" ]; then
        backup_important
    elif [ "$a" == "installs" ]; then
        backup_installs
    elif [ "$a" == "google" ]; then
        backup-google
    elif [ "$a" == "status" ]; then
        backup_status
    elif [ "$a" == "status-quiet" ]; then
        backup_status -q
    else
        echo "Command unknown"
    fi
done
