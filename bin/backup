#!/usr/bin/env bash
if command -v realpath >/dev/null 2>&1; then
    SCRIPTS="$(dirname $(realpath "${BASH_SOURCE[0]}" 2>/dev/null))"
elif command -v readlink >/dev/null 2>&1 \
    && readlink --canonicalize-existing ~ >/dev/null 2>&1; then
    SCRIPTS="$(dirname $(readlink --canonicalize-existing ${BASH_SOURCE[0]}))"
else
    SCRIPTS=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P)
    if [ "$SCRIPTS" == "${HOME}" ]; then echo "Where am I"; exit 1; fi
fi
. $SCRIPTS/../conf/bashrc --short

FOLDERS='documents local pictures'
backup_status() {
    WAVE=`echo $(( $(date +%s) - $(stat -f%c $LOCALDOT/status/wave.lastbackup) ))`
    GOOG=`echo $(( $(date +%s) - $(stat -f%c $LOCALDOT/status/google.lastbackup) ))`
    ICLO=`echo $(( $(date +%s) - $(stat -f%c $LOCALDOT/status/icloud.lastbackup) ))`
    DAY="86400"
    DAYTwo="172800"
    DAYThree="259200"
    if [ "$WAVE" -ge "$DAY" ]; then echo "Wave"; fi
    if [ "$GOOG" -ge "$DAYThree" ]; then echo "Google"; fi
    if [ "$ICLO" -ge "$DAY" ]; then echo "iCloud"; fi
}


backup_important() {
    for f in $FOLDERS; do
        cd ~/$f
        build ssh with-agent build git autocommit
    done

    cd ~/
    if [ "$ARCHIVE_RECIPIENT" ]; then
        build archive archive -f word .password-store ~/local/archive
        build archive archive -f local .local-dot ~/local/archive
    fi
}

backup_installs() {
    build install store $DOT/install
}

backup-wave() {
    name="wave"
    completed=""
    for f in $FOLDERS; do
        $TIMEOUT rsync -av --delete-excluded --delete --exclude='.tags' ~/$f/ wave:~/backup/$f/
        if [ "$?" != "0" ]; then completed="no"; fi
    done
    if [ "$completed" == "" ]; then
        date > $LOCALDOT/status/${name}.lastbackup
    fi
}
backup-icloud() {
    name="icloud"
    completed=""
    for f in $FOLDERS; do
        $TIMEOUT rsync -av --delete-excluded --delete --exclude='.tags' ~/$f/ ~/library/Mobile\ Documents/com~apple~CloudDocs/backup/$f/
        if [ "$?" != "0" ]; then completed="no"; fi
    done
    if [ "$completed" == "" ]; then
        date > $LOCALDOT/status/${name}.lastbackup
    fi
}

backup-google() {
    name="google"
    completed=""
    for f in $FOLDERS; do
        $TIMEOUT gdrsync.py -s -d -r ~/$f/ backup/$f/ -v
        if [ "$?" != "0" ]; then completed="no"; fi
    done
    if [ "$completed" == "" ]; then
        date > $LOCALDOT/status/${name}.lastbackup
    fi
}


if [ ! -f $LOCALDOT/status/backup.me ]; then
    exit
fi

export TIMEOUT="build etc timeout 1200"
if [ "$1" == "--full" ]; then
    TIMEOUT=""
    shift
fi

for a in $@; do
    if [ "$a" == "important" ]; then
        backup_important
    elif [ "$a" == "installs" ]; then
        backup_installs
    elif [ "$a" == "google" ]; then
        backup-google
    elif [ "$a" == "wave" ]; then
        backup-wave
    elif [ "$a" == "icloud" ]; then
        backup-icloud
    elif [ "$a" == "status" ]; then
        backup_status
    else
        echo "Command unknown"
    fi
done
